<!--
  Boatmate Warranty Intake Form
  =============================

  PURPOSE
  - Collects dealer/customer and warranty claim details for Boatmate trailers.
  - Posts via multipart/form-data to the Cloudflare Worker warranty endpoint.
  - Supports image/document uploads: .jpg, .jpeg, .png, .heic, .pdf, .docx, .xlsx.

  LAYOUT / UX
  - Mobile-first, responsive CSS grid:
      • All fields stack in a single column on small screens.
      • Dealer/Customer sections use an auto-fit grid on wider screens.
      • Top row of warranty info is a strict 3-column layout (VIN / Date / Ship To).
      • Remaining warranty fields are a 2-column layout with “File Upload” spanning both.
  - `box-sizing: border-box` globally to avoid horizontal scrolling issues.
  - Form is centered using a `.wrapper` with max-width and side padding.

  CONDITIONAL LOGIC (handled client-side in JS)
  - “Who is submitting this claim?” (radio):
      • If Dealer:
          - All Dealer fields are required.
          - All Customer fields are optional.
          - “Original owner?” fieldset is hidden and cleared.
          - Labor Rate / Labor Hours are visible and required.
      • If Trailer Owner:
          - All Customer fields are required.
          - All Dealer fields are optional.
          - “Original owner?” fieldset is shown and required.
          - Labor Rate / Labor Hours are hidden and optional.
  - VIN is normalized to uppercase and validated against 17-char VIN pattern (no I/O/Q).
  - Honeypot (`website` field) silently accepts bots without creating a real submission.

  INTEGRATION EXPECTATIONS
  - Backend Cloudflare Worker:
      • Validates VIN and email.
      • Issues sequential Claim # via Durable Object.
      • Upserts HubSpot Contact and creates a Ticket in Warranty pipeline.
      • Uploads attachments to HubSpot Files and associates them via Note.
      • Optionally sends confirmation email (Brevo), using “who is submitting” to
        determine which email address to treat as primary.

  NOTE
  - Keep IDs and `name` attributes in sync with the Worker and HubSpot property mappings
    before changing any form field names.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Warranty Intake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Use border-box everywhere so padding/borders stay inside width */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    :root { --gap: 0.75rem; } 

    body {
        font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 0;
    }

    h1 {
        margin-bottom: 1rem;
    }

    form {
        width: 100%;        /* fill the wrapper */
        display: grid;
        gap: 1.5rem;
        padding: 1.5rem;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    fieldset {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem 1.25rem 1.25rem;
    }

    legend {
      font-weight: 700;
      padding: 0 0.5rem;
    }

    .wrapper {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .field-grid {
      display: grid;
      gap: var(--gap);
      margin-top: 0.75rem;
      /* Mobile-first: single column by default */
      grid-template-columns: 1fr;
    }

    /* Marker classes; actual column counts set at larger breakpoints */
    .field-grid--three { }
    .field-grid--two { }

    /* Let grid children shrink with the track */
    .field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 0;
    }

    /* On small screens, "wide" fields just take full width */
    .field-wide {
      grid-column: 1 / -1;
    }

    /* At tablet/desktop sizes, switch to multi-column layouts */
    @media (min-width: 768px) {
      /* Default grid (Dealer/Customer sections) */
      .field-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      /* Explicit 3-col grid (top warranty row) */
      .field-grid--three {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      /* Explicit 2-col grid (other warranty rows) */
      .field-grid--two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      /* Now "wide" fields really span two columns */
      .field-wide {
        grid-column: span 2;
      }
    }

    /* Tighter padding on small screens so the form doesn't feel squished */
    @media (max-width: 600px) {
        form {
            max-width: none;      /* let it fill the viewport width */
            border-radius: 0.75rem;
        }

        fieldset {
            padding: 0.75rem 0.9rem 1rem;
        }
    }

    label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    input,
    textarea,
    select,
    button {
      padding: 0.625rem 0.75rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font: inherit;
      box-sizing: border-box;
    }

    input,
    textarea,
    select {
        width: 100%;        /* fill the field */
        max-width: 100%;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    input[type="file"] {
      padding: 0.4rem 0.5rem;
    }

    /* Radio group styling */
    .radio-group {
        display: flex;
        gap: 1.5rem;          /* even horizontal spacing between options */
        margin-top: 0.25rem;
        align-items: center;
    }

    .radio-option {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.95rem;
        white-space: nowrap;  /* keeps "Trailer Owner" on one line */
    }

    .error {
      color: #b00020;
      font-size: 0.95rem;
    }

    .success {
      color: #0a7d2b;
      font-size: 0.95rem;
    }

    .visually-hidden {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    button[type="submit"] {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      background: #1f4f91;
      color: #fff;
      justify-self: center;
    }

    button[type="submit"]:hover {
      filter: brightness(1.05);
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Warranty Intake</h1>

    <!--
      PRODUCTION FORM
      ---------------
      • 3 sections: Dealer, Customer, Warranty Claim.
      • Posts to Cloudflare Worker endpoint.
      • enctype="multipart/form-data" so file upload works with and without JS.
    -->
    <form
      id="warranty-intake-form"
      method="post"
      action="https://warranty-intake-form.boatmate-trailers-llc.workers.dev/"
      enctype="multipart/form-data"
      novalidate
    >
      <!-- Hidden Category (always "Warranty") -->
      <input type="hidden" id="category" name="category" value="Warranty" />

      <!-- Who is submitting this claim? -->
      <fieldset>
        <legend>Who is submitting this claim?</legend>
        <div class="radio-group">
          <label class="radio-option" for="claim_submitted_by_dealer">
            <input
              type="radio"
              id="claim_submitted_by_dealer"
              name="claim_submitted_by"
              value="dealer"
              required
            />
            Dealer
          </label>

          <label class="radio-option" for="claim_submitted_by_customer">
            <input
              type="radio"
              id="claim_submitted_by_customer"
              name="claim_submitted_by"
              value="customer"
            />
            Trailer Owner
          </label>
        </div>
      </fieldset>

      <!-- Original Owner? (conditional) -->
      <fieldset id="original-owner-fieldset" style="display:none;">
        <legend>Are you the original owner of this trailer?</legend>
        <div class="radio-group">
          <label class="radio-option" for="original_owner_yes">
            <input
              type="radio"
              id="original_owner_yes"
              name="original_owner"
              value="yes"
            />
            Yes
          </label>

          <label class="radio-option" for="original_owner_no">
            <input
              type="radio"
              id="original_owner_no"
              name="original_owner"
              value="no"
            />
            No
          </label>
        </div>
      </fieldset>

      <!-- 1) Dealer Information -->
      <fieldset>
        <legend>Dealer Information</legend>
        <div class="field-grid">
          <div class="field field-wide">
            <label for="dealer_name">Dealership</label>
            <input
              id="dealer_name"
              name="dealer_name"
              type="text"
              autocomplete="organization"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_first_name">First Name</label>
            <input
              id="dealer_first_name"
              name="dealer_first_name"
              type="text"
              autocomplete="given-name"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_last_name">Last Name</label>
            <input
              id="dealer_last_name"
              name="dealer_last_name"
              type="text"
              autocomplete="family-name"
              required
            />
          </div>

          <div class="field field-wide">
            <label for="dealer_address">Address</label>
            <input
              id="dealer_address"
              name="dealer_address"
              type="text"
              autocomplete="address-line1"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_city">City</label>
            <input
              id="dealer_city"
              name="dealer_city"
              type="text"
              autocomplete="address-level2"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_region">State/Province/Region</label>
            <input
              id="dealer_region"
              name="dealer_region"
              type="text"
              autocomplete="address-level1"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_postal_code">Zip/Postal Code</label>
            <input
              id="dealer_postal_code"
              name="dealer_postal_code"
              type="text"
              autocomplete="postal-code"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_country">Country/Region</label>
            <input
              id="dealer_country"
              name="dealer_country"
              type="text"
              autocomplete="country"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_phone">Phone</label>
            <input
              id="dealer_phone"
              name="dealer_phone"
              type="tel"
              autocomplete="tel"
              required
            />
          </div>

          <div class="field">
            <label for="dealer_email">Email</label>
            <input
              id="dealer_email"
              name="dealer_email"
              type="email"
              autocomplete="email"
              required
            />
          </div>
        </div>
      </fieldset>

      <!-- 2) Customer Information -->
      <fieldset>
        <legend>Customer Information</legend>
        <div class="field-grid">
          <div class="field">
            <label for="customer_first_name">First Name</label>
            <input
              id="customer_first_name"
              name="customer_first_name"
              type="text"
              autocomplete="given-name"
              required
            />
          </div>

          <div class="field">
            <label for="customer_last_name">Last Name</label>
            <input
              id="customer_last_name"
              name="customer_last_name"
              type="text"
              autocomplete="family-name"
              required
            />
          </div>

          <div class="field field-wide">
            <label for="customer_address">Address</label>
            <input
              id="customer_address"
              name="customer_address"
              type="text"
              autocomplete="address-line1"
              required
            />
          </div>

          <div class="field">
            <label for="customer_city">City</label>
            <input
              id="customer_city"
              name="customer_city"
              type="text"
              autocomplete="address-level2"
              required
            />
          </div>

          <div class="field">
            <label for="customer_region">State/Province/Region</label>
            <input
              id="customer_region"
              name="customer_region"
              type="text"
              autocomplete="address-level1"
              required
            />
          </div>

          <div class="field">
            <label for="customer_postal_code">Zip/Postal Code</label>
            <input
              id="customer_postal_code"
              name="customer_postal_code"
              type="text"
              autocomplete="postal-code"
              required
            />
          </div>

          <div class="field">
            <label for="customer_country">Country/Region</label>
            <input
              id="customer_country"
              name="customer_country"
              type="text"
              autocomplete="country"
              required
            />
          </div>

          <div class="field">
            <label for="customer_phone">Phone</label>
            <input
              id="customer_phone"
              name="customer_phone"
              type="tel"
              autocomplete="tel"
              required
            />
          </div>

          <div class="field">
            <label for="customer_email">Email</label>
            <input
              id="customer_email"
              name="customer_email"
              type="email"
              autocomplete="email"
              required
            />
          </div>
        </div>
      </fieldset>

      <!-- 3) Warranty Claim Information -->
      <fieldset>
        <legend>Warranty Claim Information</legend>

        <!-- Top row: 3 columns -->
        <div class="field-grid field-grid--three">
          <div class="field">
            <label for="vin">Trailer VIN</label>
            <input
              id="vin"
              name="vin"
              type="text"
              inputmode="latin"
              autocomplete="on"
              spellcheck="false"
              maxlength="17"
              pattern="[A-HJ-NPR-Z0-9]{17}"
              required
            />
          </div>

          <div class="field">
            <label for="date_of_occurrence">Date of Occurrence</label>
            <input
              id="date_of_occurrence"
              name="date_of_occurrence"
              type="date"
              required
            />
          </div>

          <div class="field">
            <label for="ship_to">Ship To</label>
            <select id="ship_to" name="ship_to" required>
              <option value="">Select an option</option>
              <option value="Dealer">Dealer</option>
              <option value="Customer">Customer</option>
            </select>
          </div>
        </div>

        <!-- Remaining fields: 2-column grid -->
        <div class="field-grid field-grid--two">
          <div class="field">
            <label for="warranty_symptoms">Warranty Symptoms</label>
            <textarea
              id="warranty_symptoms"
              name="warranty_symptoms"
              required
            ></textarea>
          </div>

          <div class="field">
            <label for="warranty_request">Warranty Request</label>
            <textarea
              id="warranty_request"
              name="warranty_request"
              required
            ></textarea>
          </div>

          <div class="field labor-field">
            <label for="labor_rate">Warranty Labor Rate</label>
            <input
              id="labor_rate"
              name="labor_rate"
              type="number"
              step="0.01"
              min="0"
            />
          </div>

          <div class="field labor-field">
            <label for="labor_hours">Warranty Labor Hours</label>
            <input
              id="labor_hours"
              name="labor_hours"
              type="number"
              step="0.1"
              min="0"
            />
          </div>

          <div class="field field-wide">
            <label for="attachments">File Upload</label>
            <input
              id="attachments"
              name="attachments"
              type="file"
              multiple
              required
              accept=".jpg,.jpeg,.png,.heic,.pdf,.docx,.xlsx"
            />
          </div>
        </div>
      </fieldset>

      <!-- Live status region -->
      <div id="form-status" role="status" aria-live="polite"></div>

      <!-- Submit button -->
      <button type="submit">Submit Warranty Claim</button>

      <!-- Honeypot anti-bot field -->
      <div class="visually-hidden" aria-hidden="true">
        <label for="website">Leave this field empty</label>
        <input id="website" name="website" type="text" tabindex="-1" autocomplete="off" />
      </div>
    </form>
  </div> <!-- Wrapper end -->

  <script>
    (function () {
      // --------------------------
      // Global element references
      // --------------------------
      const form = document.getElementById('warranty-intake-form');
      if (!form) return;

      const statusEl = document.getElementById('form-status');
      const vinInput = document.getElementById('vin');
      const categoryInput = document.getElementById('category');
      const honeypot = document.getElementById('website');

      // "Who is submitting this claim?"
      const claimSubmittedByDealer   = document.getElementById('claim_submitted_by_dealer');
      const claimSubmittedByCustomer = document.getElementById('claim_submitted_by_customer');
      const filingRadios = form.querySelectorAll('input[name="claim_submitted_by"]');

      // Dealer / Customer fields (for required toggling)
      const dealerFields = [
        'dealer_name',
        'dealer_first_name',
        'dealer_last_name',
        'dealer_address',
        'dealer_city',
        'dealer_region',
        'dealer_postal_code',
        'dealer_country',
        'dealer_phone',
        'dealer_email'
      ].map(id => document.getElementById(id));

      const customerFields = [
        'customer_first_name',
        'customer_last_name',
        'customer_address',
        'customer_city',
        'customer_region',
        'customer_postal_code',
        'customer_country',
        'customer_phone',
        'customer_email'
      ].map(id => document.getElementById(id));

      // Original owner fieldset + radios
      const originalOwnerFieldset = document.getElementById('original-owner-fieldset');
      const originalOwnerInputs = [
        document.getElementById('original_owner_yes'),
        document.getElementById('original_owner_no')
      ];

      // Labor fields (Dealer-only)
      const laborFields = form.querySelectorAll('.labor-field');

      // --------------------------
      // Utility helpers
      // --------------------------
      function setStatus(message, ok = true) {
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.className = ok ? 'success' : 'error';
      }

      // Basic VIN format check (not a checksum)
      function validateVIN(vin) {
        const v = String(vin || '').toUpperCase().replace(/\s+/g, '');
        const re = /^[A-HJ-NPR-Z0-9]{17}$/;
        return re.test(v);
      }

      function setRequired(fields, required) {
        fields.forEach(input => {
          if (!input) return;
          if (required) {
            input.setAttribute('required', 'required');
          } else {
            input.removeAttribute('required');
          }
        });
      }

      function clearOriginalOwnerSelection() {
        originalOwnerInputs.forEach(input => {
          if (input) {
            input.checked = false;
            input.removeAttribute('required');
          }
        });
      }

      // --------------------------
      // UI sync helpers
      // --------------------------

      // 1) Dealer vs Trailer Owner requirements + original owner visibility
      function syncClaimSubmittedByRequirements() {
        const isDealer   = !!(claimSubmittedByDealer   && claimSubmittedByDealer.checked);
        const isCustomer = !!(claimSubmittedByCustomer && claimSubmittedByCustomer.checked);

        if (isDealer) {
          // Dealer is submitting: dealer fields required, customer optional, no original-owner question
          setRequired(dealerFields, true);
          setRequired(customerFields, false);
          if (originalOwnerFieldset) {
            originalOwnerFieldset.style.display = 'none';
          }
          clearOriginalOwnerSelection();
        } else if (isCustomer) {
          // Trailer Owner is submitting: customer fields required, dealer optional, show original-owner question
          setRequired(dealerFields, false);
          setRequired(customerFields, true);
          if (originalOwnerFieldset) {
            originalOwnerFieldset.style.display = 'block';
          }
          originalOwnerInputs.forEach(input => {
            if (input) input.setAttribute('required', 'required');
          });
        } else {
          // Neither selected yet
          setRequired(dealerFields, false);
          setRequired(customerFields, false);
          if (originalOwnerFieldset) {
            originalOwnerFieldset.style.display = 'none';
          }
          clearOriginalOwnerSelection();
        }
      }

      // 2) Show/hide labor fields based on "who is submitting"
      function updateLaborVisibility() {
        const selected = form.querySelector('input[name="claim_submitted_by"]:checked');
        const isDealer = selected && selected.value === 'dealer';

        laborFields.forEach(field => {
          const input = field.querySelector('input');
          if (isDealer) {
            // Show + require for dealer
            field.style.display = '';
            if (input) input.required = true;
          } else {
            // Hide + clear + optional for trailer owner / unset
            field.style.display = 'none';
            if (input) {
              input.required = false;
              input.value = '';
            }
          }
        });
      }

      // --------------------------
      // Main submit handler
      // --------------------------
      async function handleSubmit(e) {
        // If fetch isn't available, fall back to normal browser POST.
        if (!window.fetch) return;

        e.preventDefault();

        setStatus('');
        // Honeypot: if filled, quietly pretend success.
        if (honeypot && honeypot.value) {
          setStatus('Thanks! Your request has been received.', true);
          form.reset();
          if (categoryInput) categoryInput.value = 'Warranty';
          syncClaimSubmittedByRequirements();
          updateLaborVisibility();
          return;
        }

        // Let browser highlight built-in validation issues.
        if (!form.reportValidity()) {
          setStatus('Please correct the highlighted fields before submitting.', false);
          return;
        }

        // VIN normalization + custom message.
        const vinRaw = vinInput ? vinInput.value.trim() : '';
        const normalizedVin = vinRaw.toUpperCase().replace(/\s+/g, '');
        if (!validateVIN(normalizedVin)) {
          setStatus('Please enter a valid VIN (17 characters; letters I, O, Q are not used).', false);
          if (vinInput) vinInput.focus();
          return;
        }
        if (vinInput) vinInput.value = normalizedVin;

        // Ensure category is still set.
        if (categoryInput && !categoryInput.value) {
          categoryInput.value = 'Warranty';
        }

        // Use FormData so file uploads are included.
        const formData = new FormData(form);

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            body: formData
          });

          const data = await res.json().catch(() => ({}));

          if (res.ok && data.ok !== false) {
            setStatus(data.message || 'Submitted. Check your email for confirmation.');
            form.reset();
            if (categoryInput) categoryInput.value = 'Warranty';
            // Reset dynamic requirements/visibility after reset
            syncClaimSubmittedByRequirements();
            updateLaborVisibility();
          } else {
            const msg = data.message || `Submission failed (${res.status}). Please try again.`;
            setStatus(msg, false);
          }
        } catch (err) {
          setStatus('Network error. Please try again in a moment.', false);
        }
      }

      // --------------------------
      // Initial wiring & bootstrapping
      // --------------------------
      // Initial UI state on load
      syncClaimSubmittedByRequirements();
      updateLaborVisibility();

      // Keep requirements + labor fields in sync with radio changes
      filingRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          syncClaimSubmittedByRequirements();
          updateLaborVisibility();
        });
      });

      // Submit handler
      form.addEventListener('submit', handleSubmit);
    })();
  </script>
</body>
</html>
